#!/bin/sh

# Author:       Action <dev@action-server.com>
# License:      GNU GPLv3
# Description:  Open rss link

set -e
script_name="$(basename "${0}")"

trap 'cleanup' EXIT INT QUIT TERM HUP

print_error_gui(){
	notify-send --app-name="${script_name}" "Error ${message}"
}

print_error(){
	message="${1}"
	printf '%s\n' "Error: ${message}" >&2

	if [ -z "${DISPLAY}" ] ;then
		return
	fi

	print_error_gui
}

cleanup(){
	if [ "${?}" -eq 0 ]; then
		return
	fi

	if [ -z "${command_output}" ]; then
		return
	fi

	print_error "${command_output}"
}

check_arguments(){
	if [ "${#}" -ne 1 ]; then
		print_error "Usage: ${script_name} <link>"
		return 1
	fi
}

get_native_resolution(){
	native_resolution="$(xrandr --current | grep '*' | awk '{print $1; exit}' | cut -d 'x' -f2)"
}

get_media_quality(){
	quality_choice="$( \
	cat <<-'EOF' | dmenu -p 'Choose media quality' -i -l 10
	Best
	Native
	2160p 4k
	1440p 2k
	1080p Full HD
	720p HD
	480p SD
	360p
	240p
	144p
	EOF
	)"

	case "${quality_choice}" in
		'Native') get_native_resolution; quality="${native_resolution}";;
		'Best') quality='Best';;
		'2160p 4k') quality='2160';;
		'1440p 2k') quality='1440';;
		'1080p Full HD') quality='1080';;
		'720p HD') quality='720';;
		'480p SD') quality='480';;
		'360p') quality='360';;
		'240p') quality='240';;
		'144p') quality='144';;
		*) get_media_quality;;
	esac
}

open_with_audio_player(){
	link="${1}"

	command_output="$(mpv --ytdl-format='bestaudio' "${link}")"
}

open_with_video_player(){
	link="${1}"

	get_media_quality

	ytdl_format='
	bestvideo[height<='"${quality}"']+bestaudio / 
	best[height<='"${quality}"'] / 
	worstvideo+bestaudio / 
	worst'

	if [ "${quality}" = 'Best' ]; then 
		ytdl_format='best'
	fi

	command_output="$(mpv --ytdl-format="${ytdl_format}" "${link}")"
}

open_with_browser(){
	link="${1}"
	command_output="$("${BROWSER}" "${link}")"
}

get_media_player(){
	media_player="$( \
		cat <<-'EOF' | dmenu -p 'Choose' -i
	Browser
	Video
	Audio
	EOF
	)"
}

run(){
	link="${1}"

	get_media_player

	case "${media_player}" in
		'Browser') open_with_browser "${link}";;
		'Video') open_with_video_player "${link}";;
		'Audio') open_with_audio_player "${link}";;
		*) run "${link}";;
	esac
}

main(){
	check_arguments "${@}"
	run "${@}"
}

main "${@}"
